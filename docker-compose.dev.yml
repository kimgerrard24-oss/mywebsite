services:
  # === PostgreSQL Service ===
  postgres:
    container_name: mywebsite-postgres
    image: postgres:15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: Postgresql1112025
      POSTGRES_DB: mywebsite
    ports:
      - "5433:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - mywebsite-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 3s
      retries: 10

  # === Redis Service ===
  redis:
    container_name: mywebsite-redis
    image: redis:7
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - mywebsite-net

  # === Backend Service ===
  backend:
    container_name: mywebsite-backend
    build:
      context: ./backend
      dockerfile: Dockerfile

    env_file:
      - ./backend/.env.production

    environment:
      NODE_ENV: production
      DOCKER_ENV: "true"
      PORT: 4001
      REDIS_URL: redis://redis:6379

      SESSION_COOKIE_NAME: session

      # ⭐ FIXED — crucial for Google OAuth + WebSocket session
      COOKIE_DOMAIN: ".test-localmywebsite.com"

      FRONTEND_ORIGIN: "https://test-localmywebsite.com"
      GOOGLE_CALLBACK_URL: "https://api.test-localmywebsite.com/auth/google/callback"

      AWS_SECRET_NAME: "mywebsite/backend/env"
      AWS_OAUTH_SECRET_NAME: "OAuthClientIDSecretSocialLoginUrlRedirect"
      AWS_REGION: "ap-southeast-7"

      
      # 4) REQUIRED FOR FIREBASE ADMIN
      # (Base64 string from firebase-admin.json)
      FIREBASE_SERVICE_ACCOUNT_BASE64: "ew0KICAidHlwZSI6ICJzZXJ2aWNlX2FjY291bnQiLA0KICAicHJvamVjdF9pZCI6ICJteXdlYnNpdGUtMjU3M2UiLA0KICAicHJpdmF0ZV9rZXlfaWQiOiAiNWIxYzg2ZTlkMjYzMWRhOTk4NzFjZTEzMWE1NmI5MDgyMTNhNmQwZCIsDQogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRRFZUUXJ3OEpKRVZaMjlcbnlCRS9iRzEwTC85U0FYK3pJVkI2RzRnUHhRcWRuT2R6OUtDZUtwZUpZYVI1cnFKQ1V3ZTFvZW4zZlhhQ2wyeTBcbkd4ZlhOOURRUkFiUGd0WWlzd2s0Yll1N0J2Um81Z2J1dHJXWGQ4YzE4cC9ZTHd2U0lwYmVHTjJnN0o4bmxoeURcbnl2bVhOS1UreVAxeHBnOUNkUFZZTEZBWjFTb0Q5R1RlQk9DbUdTU1BFUDRjZ243Q3d3Y2svVE5BQnYyRHdxaWlcbkkzMXJBV2ZTRjJBRS9vSldtd1E0bEsyL2dReStZdjR1WXFZK1l0NksvcHloVlBVYWNDZk0rMXJJdzJrc2lUN2pcbmxMQnRTS1phSzRlMHp3Q3RSZXBLcDBXR1ZNWkhzOFYzMVBLcFpObi9VSWpVMWxOSEJTQWNtOTRDR0grSWdmM0FcblZVL00xWU9wQWdNQkFBRUNnZ0VBQlkvdHdoeXo0NzVMejhBZzJ3T0wweVRSUnFVdFhGRjVGTVlWQlR4Qks1MEVcbjJCdy85Ly9xVmJYTElUVXhuQU1vUjA5Q2w2YVk2WXpqVThzRkV5S3NlbEhiejV0ODFBalJLN3lIa1VmOEphUWhcbitDV2hsS0tWK2swcVordktKaCtxeVgzaWdhakorYkZMYXhCbTg4OTJvNjJBRm0rYkpFT0NobHNaZDZMOFpuL3pcbjFNUHJwY3lPUlNNZ2lTRENFZnhZcU1saEZoUDJyOER1TGp0L0U2T3FWbjV4ZVVnRDFkWVNOR2t1NnJ4VlB3UGNcbkNYVjAzMWk1UVZ4dyt0aU8zYVBUUGp2bjJBRkFMWCtMOHNxbGRMbXlzZktJWW43SkNjcGMrcGpHaGVWMVlua05cbnR3Y2w4TmU4WWI2YXNtZEc0ZjNHSXVMOHAxMlBhMGdpamdvV1ZuUTh0UUtCZ1FEdXFJRll6Z1F6ZEVzdWRycURcblpCRm8xckhWYTBubURZRm5VSmdteHBteHhzWVN5OFBGVWRqLy9aQnEvNk0rTnh3UDNKUW1BbHRjMjJPbHlla05cbjZ3S0ZzZmd5TlEvT1FUc2lMUHVmRXdxSWplZDhxanhCbDJucnBDL0VtaGZZVXZDT1JyamVqa3FGUkt0UDFIcHFcblVYSk90Qm5xM2U4SXh1ck9MWWRSLzJBL3V3S0JnUURrek5nYVlzTCtWU0lpUzl3c3NONTExMW5xYTVNdkxBT01cbnBDRTh0Ukl1ZEtnSnRRbHdNaWpyY1M4ejdwQ3FPZEV2SWhrTW4wRVdhMzV6dWtmWWVjWGhUMnNhenlmMytzWjdcbkNKaTdLaUtrRVVtSktpZVFIUDFJcDdPMERWaHpJbUpyZFVsNG5xdmw5VjRBK2hKUlU0dm9od3doT2JOT3lOajRcbmJEWUs1MGxaNndLQmdHQnV3LzBQR1pGMDd4L3lKNEVKd1NNY2hUVFlLajhEdkFMMEJOYStMc0l2c0Q5T0NHZkZcbm42b29XZDl5TmhMZ2o3MDFBc09zOWgrNklqU09ObFpDWEgyTElOK2dveWRUSWtLMzdHQWxnSDhXMzY5MjFld21cbjgweWN4aFJwc3pMY3FJakV1TlJzcUYzYkZtR21XR1IzVG5uUXVodzEydTB2K3hhZVBPeDhCUGNiQW9HQWRZN09cbnBsZ0NTbjFoaVcraTFBK1liY0hWZ0QzL3BPZ2ZkcjdLR1JBTUpIUnA5bnJmTzVkNk1PYTUweHdMbG5zWWdQZ3JcbkdMSW0xaWNyRkxrc3V3eHVZTUxXakRMT0hYcnJTa0h6ZjQ4NXQwVHVuSnhkTVkzRGtmWWd2aTF4T2M3NzlLeVJcbnNIa09aNXczelphdm5MdXBrakw1UjRVSEhUN1RSR2tOSjNNSTNEc0NnWUVBbjRtdWEwMjdxZ2d6RENPN21OVGpcbnNndUNDS0tpb1BFK0NUT2h5REg0WnpWemlGVW9JZkxNZmlhYTBTQW56Mmt0dmdJMlJFdDlTL3I5cThzaW5aQ2dcblVleG9nV1Y1ZXdna3FVRXdlWHFzUkdVRi9yejdLL2dVcG1BOXB5b0syN0lqMVlsSm40MW41dDNqeENnc3ovYlBcbk01cnZ3R1BFbG95SzBNdkd1TWlweTIwPVxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwNCiAgImNsaWVudF9lbWFpbCI6ICJmaXJlYmFzZS1hZG1pbnNkay1mYnN2Y0BteXdlYnNpdGUtMjU3M2UuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLA0KICAiY2xpZW50X2lkIjogIjEwMDY4MzA4Mjg1MjI4MjcyOTg2MyIsDQogICJhdXRoX3VyaSI6ICJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20vby9vYXV0aDIvYXV0aCIsDQogICJ0b2tlbl91cmkiOiAiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5jb20vdG9rZW4iLA0KICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsDQogICJjbGllbnRfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9yb2JvdC92MS9tZXRhZGF0YS94NTA5L2ZpcmViYXNlLWFkbWluc2RrLWZic3ZjJTQwbXl3ZWJzaXRlLTI1NzNlLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwNCiAgInVuaXZlcnNlX2RvbWFpbiI6ICJnb29nbGVhcGlzLmNvbSINCn0="

      

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started

    networks:
      - mywebsite-net

    command: ["node", "dist/main.js"]

    volumes: []

    ports:
      - "4001:4001"

  # === Frontend Service (Next.js) ===
  frontend:
    container_name: mywebsite-frontend
    hostname: frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile

    env_file:
      - ./frontend/.env.production

    environment:
      NODE_ENV: production
      HOSTNAME: "0.0.0.0"
      NEXT_PUBLIC_API_BASE: "https://api.test-localmywebsite.com"
      NEXT_PUBLIC_BACKEND_URL: "https://api.test-localmywebsite.com"

    depends_on:
      - backend

    networks:
      - mywebsite-net

    ports:
      - "3000:3000"

    volumes: []

    expose:
      - "3000"

  # === Caddy Reverse Proxy (SSL) ===
  caddy:
    image: caddy:latest
    container_name: mywebsite-caddy
    restart: always
    command: ["caddy", "run", "--config", "/etc/caddy/Caddyfile", "--adapter", "caddyfile"]
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./caddy:/etc/caddy
      - ./certs:/etc/certs

      # ⭐ MUST KEEP ONLY THIS ONE (persist PKI)
      - caddy-data:/data

    networks:
      - mywebsite-net

networks:
  mywebsite-net:
    driver: bridge

volumes:
  redis-data: {}
  postgres-data: {}
  caddy-data: {}   # ⭐ KEEP ONLY THIS (correct)
