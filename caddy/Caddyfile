{
    email admin@phlyphant.com
}

# ======================================
# FRONTEND (Next.js)
# ======================================
phlyphant.com, www.phlyphant.com {

    encode gzip

    tls /etc/caddy/cloudflare.crt /etc/caddy/cloudflare.key {
        protocols tls1.2 tls1.3
    }

    header {
        Strict-Transport-Security "max-age=15552000; includeSubDomains; preload"
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"

        Content-Security-Policy "
            default-src 'self';
            script-src 'self' 'unsafe-inline' https: blob:;
            worker-src 'self' blob:;
            img-src 'self' data: https:;
            style-src 'self' 'unsafe-inline' https:;
            font-src 'self' https: data:;
            connect-src
                'self'
                https://api.phlyphant.com
                wss://api.phlyphant.com
                https://accounts.google.com
                https://oauth2.googleapis.com
                https://www.facebook.com
                https://graph.facebook.com
                https://*.sentry.io
                https://o4510359449042944.ingest.us.sentry.io
                https://*.amazonaws.com
                https://fonts.googleapis.com
                https://fonts.gstatic.com;
            frame-src
                'self'
                https://accounts.google.com
                https://www.facebook.com;
            frame-ancestors 'self';
        "
    }

    # ==================================================
    # SHARE LINK ENTRY (BACKEND AUTHORITY)
    # ==================================================
    @share_links {
        path /s/*
    }

    handle @share_links {
        reverse_proxy api.phlyphant.com {
            header_up Host {host}
            header_up X-Forwarded-For {remote}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-Proto {scheme}
            header_up Cookie {http.request.header.Cookie}
        }
    }

    # ==================================================
    # DEFAULT FRONTEND (Next.js)
    # ==================================================
    handle {
        reverse_proxy phlyphant-frontend:3000 {
            header_up Host {host}
            header_up X-Forwarded-For {remote}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-Proto {scheme}
            header_up Cookie {http.request.header.Cookie}
        }
    }
}

# ======================================
# BACKEND (NestJS + Socket.IO)
# ======================================
api.phlyphant.com {

    encode gzip

    tls /etc/caddy/cloudflare.crt /etc/caddy/cloudflare.key {
        protocols tls1.2 tls1.3
    }

    # --------------------------------------------------
    # BLOCK DANGEROUS HTTP METHODS
    # --------------------------------------------------
    @invalid_methods {
        method TRACE CONNECT
    }
    respond @invalid_methods 405

    # --------------------------------------------------
    # PROTECT HEALTH & SYSTEM CHECK
    # --------------------------------------------------
    @health_protected {
        path /health* /system-check*
        not header X-Health-Token REPLACE_WITH_LONG_RANDOM_SECRET
    }
    respond @health_protected 403

    # --------------------------------------------------
    # BASIC REQUEST HARDENING
    # --------------------------------------------------
    request_body {
        max_size 10MB
    }

    header {
        Strict-Transport-Security "max-age=15552000; includeSubDomains; preload"
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"

        Content-Security-Policy "
            default-src 'none';
            frame-ancestors 'none';
            connect-src
                'self'
                https://phlyphant.com
                https://www.phlyphant.com
                https://api.phlyphant.com
                wss://api.phlyphant.com
                https://accounts.google.com
                https://oauth2.googleapis.com
                https://www.facebook.com
                https://graph.facebook.com
                https://*.sentry.io
                https://o4510359449042944.ingest.us.sentry.io
                https://*.amazonaws.com;
        "
    }

    # ===============================
    # Socket.IO
    # ===============================
    @socketio {
        path /socket.io*
    }

    handle @socketio {
        reverse_proxy phlyphant-backend:4001 {
            transport http {
                versions 1.1
            }

            header_up Host {host}
            header_up X-Forwarded-For {remote}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-Proto {scheme}
            header_up Upgrade {http.request.header.Upgrade}
            header_up Connection {http.request.header.Connection}
            header_up Cookie {http.request.header.Cookie}
        }
    }

    # ===============================
    # NORMAL API TRAFFIC
    # ===============================
    handle {
        reverse_proxy phlyphant-backend:4001 {
            transport http {
                versions 1.1
            }

            header_up Host {host}
            header_up X-Forwarded-For {remote}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-Proto {scheme}
            header_up Cookie {http.request.header.Cookie}
        }
    }
}
